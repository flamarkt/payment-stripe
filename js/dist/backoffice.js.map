{"version":3,"file":"backoffice.js","mappings":"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","sources":["webpack://@flamarkt/balance/webpack/bootstrap","webpack://@flamarkt/balance/webpack/runtime/compat get default export","webpack://@flamarkt/balance/webpack/runtime/define property getters","webpack://@flamarkt/balance/webpack/runtime/hasOwnProperty shorthand","webpack://@flamarkt/balance/webpack/runtime/make namespace object","webpack://@flamarkt/balance/external root \"((flarum.extensions['flamarkt-backoffice']||{})['backoffice']||{})['app']\"","webpack://@flamarkt/balance/external root \"flarum.core.compat['common/extend']\"","webpack://@flamarkt/balance/external root \"((flarum.extensions['flamarkt-core']||{})['backoffice']||{})['components/PaymentList']\"","webpack://@flamarkt/balance/external root \"flarum.core.compat['common/components/Button']\"","webpack://@flamarkt/balance/./node_modules/@babel/runtime/helpers/esm/setPrototypeOf.js","webpack://@flamarkt/balance/external root \"flarum.core.compat['common/components/Modal']\"","webpack://@flamarkt/balance/external root \"((flarum.extensions['flamarkt-core']||{})['common']||{})['components/PriceInput']\"","webpack://@flamarkt/balance/external root \"((flarum.extensions['flamarkt-core']||{})['common']||{})['components/PriceLabel']\"","webpack://@flamarkt/balance/external root \"flarum.core.compat['common/utils/ItemList']\"","webpack://@flamarkt/balance/./src/backoffice/components/CaptureFundsModal.ts","webpack://@flamarkt/balance/./node_modules/@babel/runtime/helpers/esm/inheritsLoose.js","webpack://@flamarkt/balance/./src/backoffice/compat.ts","webpack://@flamarkt/balance/./src/backoffice/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","const __WEBPACK_NAMESPACE_OBJECT__ = ((flarum.extensions['flamarkt-backoffice']||{})['backoffice']||{})['app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = ((flarum.extensions['flamarkt-core']||{})['backoffice']||{})['components/PaymentList'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Button'];","export default function _setPrototypeOf(o, p) {\n  _setPrototypeOf = Object.setPrototypeOf ? Object.setPrototypeOf.bind() : function _setPrototypeOf(o, p) {\n    o.__proto__ = p;\n    return o;\n  };\n  return _setPrototypeOf(o, p);\n}","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/components/Modal'];","const __WEBPACK_NAMESPACE_OBJECT__ = ((flarum.extensions['flamarkt-core']||{})['common']||{})['components/PriceInput'];","const __WEBPACK_NAMESPACE_OBJECT__ = ((flarum.extensions['flamarkt-core']||{})['common']||{})['components/PriceLabel'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/utils/ItemList'];","import {Children, Vnode} from 'mithril';\nimport app from 'flamarkt/backoffice/backoffice/app';\nimport Modal, {IInternalModalAttrs} from 'flarum/common/components/Modal';\nimport PriceInput from 'flamarkt/core/common/components/PriceInput';\nimport PriceLabel from 'flamarkt/core/common/components/PriceLabel';\nimport Order from 'flamarkt/core/common/models/Order';\nimport Payment from 'flamarkt/core/common/models/Payment';\nimport ItemList from 'flarum/common/utils/ItemList';\nimport Button from 'flarum/common/components/Button';\n\ninterface IframeModalAttrs extends IInternalModalAttrs {\n    order: Order\n    payment: Payment\n}\n\nexport default class CaptureFundsModal extends Modal<IframeModalAttrs> {\n    paidWithOtherMethods!: number\n    amountDue!: number\n    amount!: number\n    saving: boolean = false;\n\n    oninit(vnode: Vnode) {\n        super.oninit(vnode);\n\n        const {order} = this.attrs;\n\n        this.paidWithOtherMethods = order.paidAmount() - (this.attrs.payment.amount() || 0);\n\n        this.amountDue = order.priceTotal() - this.paidWithOtherMethods;\n        this.amount = this.amountDue;\n    }\n\n    className(): string {\n        return 'FlamarktStripeCaptureFundsModal';\n    }\n\n    title() {\n        return 'Capture Funds';\n    }\n\n    content() {\n        return m('.Modal-body', this.fields().toArray());\n    }\n\n    fields(): ItemList<Children> {\n        const fields = new ItemList<Children>();\n\n        const {order, payment} = this.attrs;\n\n        fields.add('info', m('.Form-group', [\n            m('dl', [\n                m('dt', 'Order total'),\n                m('dd', PriceLabel.component({\n                    value: order.priceTotal(),\n                })),\n            ]),\n            m('dl', [\n                m('dt', 'Paid with other methods'),\n                m('dd', PriceLabel.component({\n                    value: this.paidWithOtherMethods,\n                })),\n            ]),\n            m('dl', [\n                m('dt', 'Amount due'),\n                m('dd', PriceLabel.component({\n                    value: this.amountDue,\n                })),\n            ]),\n            m('dl', [\n                m('dt', 'Amount on hold'),\n                m('dd', PriceLabel.component({\n                    value: payment.amount(),\n                })),\n            ]),\n        ]), 20);\n\n        fields.add('amount', m('.Form-group', [\n            m('label', 'Amount'),\n            m(PriceInput, {\n                value: this.amount,\n                onchange: (value: number) => {\n                    this.amount = value;\n                },\n                disabled: this.saving,\n            }),\n        ]), 10);\n\n        fields.add('submit', m('.Form-group', [\n            Button.component({\n                type: 'submit',\n                className: 'Button Button--primary',\n                loading: this.saving,\n            }, 'Confirm'),\n        ]), -10);\n\n        return fields;\n    }\n\n    onsubmit(event: Event) {\n        event.preventDefault();\n\n        this.saving = true;\n\n        app.request({\n            method: 'POST',\n            url: app.forum.attribute('apiUrl') + '/flamarkt/stripe-capture',\n            body: {\n                paymentIntentId: this.attrs.payment.identifier(),\n                amount: this.amount,\n            },\n            errorHandler: this.onerror.bind(this),\n        }).then(() => {\n            this.hide();\n            app.alerts.show({\n                type: 'success',\n            }, 'Funds captured. Refresh page to see.');\n        }).catch(error => {\n            this.saving = false;\n            m.redraw();\n            throw error;\n        });\n    }\n}\n","import setPrototypeOf from \"./setPrototypeOf.js\";\nexport default function _inheritsLoose(subClass, superClass) {\n  subClass.prototype = Object.create(superClass.prototype);\n  subClass.prototype.constructor = subClass;\n  setPrototypeOf(subClass, superClass);\n}","import CaptureFundsModal from './components/CaptureFundsModal';\n\nexport const backoffice = {\n    'components/CaptureFundsModal': CaptureFundsModal,\n}\n","import app from 'flamarkt/backoffice/backoffice/app';\nimport {extend} from 'flarum/common/extend';\nimport PaymentList from 'flamarkt/core/backoffice/components/PaymentList';\nimport Order from 'flamarkt/core/common/models/Order';\nimport Button from 'flarum/common/components/Button';\nimport {backoffice} from './compat';\nimport CaptureFundsModal from './components/CaptureFundsModal';\n\nexport {\n    backoffice,\n};\n\napp.initializers.add('flamarkt-payment-stripe', () => {\n    app.extensionData.for('flamarkt-payment-stripe')\n        .registerSetting({\n            type: 'text',\n            setting: 'flamarkt-payment-stripe.secretKey',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.secretKey'),\n        })\n        .registerSetting({\n            type: 'text',\n            setting: 'flamarkt-payment-stripe.publishableKey',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.publishableKey'),\n        })\n        .registerSetting({\n            type: 'switch',\n            setting: 'flamarkt-payment-stripe.hostedCheckout',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.hostedCheckout'),\n            help: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.hostedCheckoutHelp'),\n        })\n        .registerSetting({\n            type: 'switch',\n            setting: 'flamarkt-payment-stripe.alwaysRedirect',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.alwaysRedirect'),\n            help: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.alwaysRedirectHelp'),\n        })\n        .registerSetting({\n            type: 'switch',\n            setting: 'flamarkt-payment-stripe.cardOnly',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.cardOnly'),\n            help: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.cardOnlyHelp'),\n        })\n        .registerSetting({\n            type: 'switch',\n            setting: 'flamarkt-payment-stripe.captureLater',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.captureLater'),\n            help: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.captureLaterHelp'),\n        })\n        .registerSetting({\n            type: 'switch',\n            setting: 'flamarkt-payment-stripe.forceLocaleAuto',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.forceLocaleAuto'),\n            help: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.forceLocaleAutoHelp'),\n        })\n        .registerSetting({\n            type: 'switch',\n            setting: 'flamarkt-payment-stripe.applePayDomainAssociation',\n            label: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.applePayDomainAssociation'),\n            help: app.translator.trans('flamarkt-payment-stripe.backoffice.settings.applePayDomainAssociationHelp'),\n        });\n\n    extend(PaymentList.prototype, 'actions', function (items, payment) {\n        if (payment.method() === 'stripe-intent-hold') {\n            items.add('stripe-capture', Button.component({\n                icon: 'fas fa-credit-card',\n                className: 'Button',\n                onclick() {\n                    const order = app.store.all<Order>('flamarkt-orders').find(order => {\n                        return (order.payments() || []).some(p => p === payment);\n                    });\n\n                    if (!order) {\n                        // Shouldn't happen since the payment is loaded through an order relationship in the first place\n                        console.error('Could not find order payment belongs to');\n                        return;\n                    }\n\n                    app.modal.show(CaptureFundsModal, {\n                        order,\n                        payment,\n                    });\n                },\n            }, 'Capture funds'));\n        }\n    });\n});\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","flarum","extensions","core","compat","_setPrototypeOf","p","setPrototypeOf","bind","__proto__","CaptureFundsModal","subClass","superClass","paidWithOtherMethods","amountDue","amount","saving","create","constructor","oninit","vnode","order","this","attrs","paidAmount","payment","priceTotal","className","title","content","m","fields","toArray","ItemList","add","PriceLabel","PriceInput","onchange","disabled","Button","type","loading","onsubmit","event","preventDefault","app","method","url","body","paymentIntentId","identifier","errorHandler","onerror","then","hide","error","redraw","Modal","backoffice","registerSetting","setting","label","help","extend","PaymentList","items","icon","onclick","find","payments","some","console"],"sourceRoot":""}